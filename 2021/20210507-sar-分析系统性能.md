# sar命令--分析系统性能

---

sar 命令很强大，是分析系统性能的重要工具之一，通过该命令可以全面地获取系统的 CPU、运行队列、磁盘读写（I/O）、分区（交换区）、内存、CPU 中断和网络等性能数据

## 基本格式如下：

```
[root@localhost ~]# sar [options] [-o filename] interval [count]
```

此命令格式中，各个参数的含义如下：

+   -o filename：其中，filename 为文件名，此选项表示将命令结果以二进制格式存放在文件中
+   interval：表示采样间隔时间，该参数必须手动设置
+   count：表示采样次数，是可选参数，其默认值为 1
+   options：为命令行选项，由于 sar 

## 常用命令选项

|sar命令选项| 功能 |
|----|----|
| -A  | 显示系统所有资源设备（CPU、内存、磁盘）的运行状况。|
| -u  | 显示系统所有 CPU 在采样时间内的负载状态。|
| -P  | 显示当前系统中指定 CPU 的使用情况。|
| -d  | 显示系统所有硬盘设备在采样时间内的使用状态。|
| -r  | 显示系统内存在采样时间内的使用情况。|
| -b  | 显示缓冲区在采样时间内的使用情况。|
| -v  | 显示 inode 节点、文件和其他内核表的统计信息。|
| -n  | 显示网络运行状态，此选项后可跟 DEV（显示网络接口信息）、EDEV（显示网络错误的统计数据）、SOCK（显示套接字信息）和 FULL（等同于使用 DEV、EDEV和SOCK）等，有关更多的选项，可通过执行 man sar 命令查看。|
| -q  | 显示运行列表中的进程数、进程大小、系统平均负载等。|
| -R  | 显示进程在采样时的活动情况。|
| -y  | 显示终端设备在采样时间的活动情况。|
| -w  | 显示系统交换活动在采样时间内的状态。|

## 查看系统 CPU 的整体负载状况
```
// 每 3 秒统计一次，统计 5 次

[root@localhost ~]# sar -u 3 5
Linux 2.6.32-431.el6.x86_64 (localhost)     10/25/2019     _x86_64_    (1 CPU)

06:18:23 AM     CPU     %user     %nice   %system   %iowait    %steal     %idle
06:18:26 AM     all     12.11      0.00      2.77      3.11      0.00     82.01
06:18:29 AM     all      6.55      0.00      2.07      0.00      0.00     91.38
06:18:32 AM     all      6.60      0.00      2.08      0.00      0.00     91.32
06:18:35 AM     all     10.21      0.00      1.76      0.00      0.00     88.03
06:18:38 AM     all      8.71      0.00      1.74      0.00      0.00     89.55
Average:        all      8.83      0.00      2.09      0.63      0.00     88.46
```
此输出结果中，各个列表项的含义分别如下：

+   %user：用于表示用户模式下消耗的 CPU 时间的比例；
+   %nice：通过 nice 改变了进程调度优先级的进程，在用户模式下消耗的 CPU 时间的比例；
+   %system：系统模式下消耗的 CPU 时间的比例；
+   %iowait：CPU 等待磁盘 I/O 导致空闲状态消耗的时间比例；
+   %steal：利用 Xen 等操作系统虚拟化技术，等待其它虚拟 CPU 计算占用的时间比例；
+   %idle：CPU 空闲时间比例。


## 查看系统磁盘的读写性能

```
[root@localhost ~]# sar -d 3 5
Linux 2.6.32-431.el6.x86_64 (localhost)     10/25/2019     _x86_64_    (1 CPU)

06:36:52 AM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
06:36:55 AM    dev8-0      3.38      0.00    502.26    148.44      0.08     24.11      4.56      1.54

06:36:55 AM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
06:36:58 AM    dev8-0      1.49      0.00     29.85     20.00      0.00      1.75      0.75      0.11

06:36:58 AM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
06:37:01 AM    dev8-0     68.26      6.96  53982.61    790.93      3.22     47.23      3.54     24.17

06:37:01 AM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
06:37:04 AM    dev8-0    111.69   3961.29    154.84     36.85      1.05      9.42      3.44     38.43

06:37:04 AM       DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
06:37:07 AM    dev8-0      1.67    136.00      2.67     83.20      0.01      6.20      6.00      1.00

Average:          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
Average:       dev8-0     34.45    781.10   9601.22    301.36      0.78     22.74      3.50     12.07
```

此输出结果中，各个列表头的含义如下：

+   tps：每秒从物理磁盘 I/O 的次数。注意，多个逻辑请求会被合并为一个 I/O 磁盘请求，一次传输的大小是不确定的；
+   rd_sec/s：每秒读扇区的次数；
+   wr_sec/s：每秒写扇区的次数；
+   avgrq-sz：平均每次设备 I/O 操作的数据大小（扇区）；
+   avgqu-sz：磁盘请求队列的平均长度；
+   await：从请求磁盘操作到系统完成处理，每次请求的平均消耗时间，包括请求队列等待时间，单位是毫秒（1 秒=1000 毫秒）；
+   svctm：系统处理每次请求的平均时间，不包括在请求队列中消耗的时间；
+   %util：I/O 请求占 CPU 的百分比，比率越大，说明越饱和。

## 查看网络运行状态

```
[root@localhost ~]# sar -n TCP 1 10
Linux 3.10.0-862.el7.x86_64 (localhost)  05/07/2021  _x86_64_    (2 CPU)

02:22:25 PM  active/s passive/s    iseg/s    oseg/s
02:22:26 PM    101.00      0.00   1035.00    592.00
02:22:27 PM    128.00      0.00   1602.00   1117.00
02:22:28 PM     53.00      0.00    983.00    791.00
02:22:29 PM     86.00      0.00    684.00    590.00
02:22:30 PM     77.00      0.00    453.00    447.00
02:22:31 PM     39.00      0.00    796.00    469.00
02:22:32 PM      0.00      0.00   1298.00    651.00
02:22:33 PM      0.00      0.00    511.00    337.00
02:22:34 PM      0.00      0.00    204.00    161.00
02:22:35 PM      0.00      0.00    140.00    148.00
Average:        48.40      0.00    770.60    530.30
```

+   active/s 新的主动连接
+   passive/s 新的被动连接
+   iseg/s 接受的段
+   oseg/s 输出的段

| sar -n 使用总结 | 说明 |
|----|----|
| -n DEV | 网络接口统计信息|
| -n EDEV | 网络接口错误|
| -n IP | IP数据报统计信息|
| -n EIP | IP错误统计信息|
| -n TCP | TCP统计信息|
| -n ETCP | TCP错误统计信息|
| -n SOCK | 套接字使用|


## 查看系统内存使用情况

```
sar -r 5 3
```

## 设备使用情况监控

例如，每10秒采样一次，连续采样3次，报告设备使用情况，需键入如下命令：
```
# sar -d 10 3 –p
17:45:54    DEV    tps    rd_sec/s    wr_sec/s    avgrq-sz    avgqu-sz    await    svctm    %util

17:46:04    scd0    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

17:46:04    sda    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

17:46:04    vg_livedvd-lv_root    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00

17:46:04    vg_livedvd-lv_swap    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00
```

其中：

+   参数-p可以打印出sda,hdc等磁盘设备名称,如果不用参数-p,设备节点则有可能是dev8-0,dev22-0
+   tps:每秒从物理磁盘I/O的次数.多个逻辑请求会被合并为一个I/O磁盘请求,一次传输的大小是不确定的.
+   rd_sec/s:每秒读扇区的次数.
+   wr_sec/s:每秒写扇区的次数.
+   avgrq-sz:平均每次设备I/O操作的数据大小(扇区).
+   avgqu-sz:磁盘请求队列的平均长度.
+   await:从请求磁盘操作到系统完成处理,每次请求的平均消耗时间,包括请求队列等待时间,单位是毫秒(1秒=1000毫秒).
+   svctm:系统处理每次请求的平均时间,不包括在请求队列中消耗的时间.
+   %util:I/O请求占CPU的百分比,比率越大,说明越饱和.

结论

+   avgqu-sz 的值较低时，设备的利用率较高。
+   当%util的值接近 1% 时，表示设备带宽已经占满。

## 要判断系统瓶颈问题，有时需几个 sar 命令选项结合起来

+   怀疑CPU存在瓶颈，可用 sar -u 和 sar -q 等来查看
+   怀疑内存存在瓶颈，可用 sar -B、sar -r 和 sar -W 等来查看
+   怀疑I/O存在瓶颈，可用 sar -b、sar -u 和 sar -d 等来查看

# 参考
https://www.cnblogs.com/liyongsan/p/7459523.html
